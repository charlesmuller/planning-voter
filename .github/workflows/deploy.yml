name: Deploy to VPS

on:
  push:
    branches:
      - main
  workflow_dispatch:  # Permite execução manual do workflow

env:
  DOCKER_COMPOSE_VERSION: v2.20.2

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment: production

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Cache Docker layers
        uses: actions/cache@v3
        with:
          path: /tmp/.buildx-cache
          key: ${{ runner.os }}-buildx-${{ github.sha }}
          restore-keys: |
            ${{ runner.os }}-buildx-

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v2

      - name: Configure Docker and Docker Compose
        run: |
          # Instala dependências essenciais
          sudo apt-get update
          sudo apt-get install -y apt-transport-https ca-certificates curl software-properties-common

          # Instala Docker via get.docker.com
          curl -fsSL https://get.docker.com -o get-docker.sh
          sudo sh get-docker.sh

          # Instala versão específica do Docker Compose
          sudo curl -L "https://github.com/docker/compose/releases/download/${DOCKER_COMPOSE_VERSION}/docker-compose-$(uname -s)-$(uname -m)" -o /usr/local/bin/docker-compose
          sudo chmod +x /usr/local/bin/docker-compose

      - name: Build and Test Docker Images
        run: |
          # Construir imagens
          docker-compose -f docker-compose.yml build

          # Validar composição do docker-compose
          docker-compose -f docker-compose.yml config

      - name: Create environment files
        env:
          BASE_URL: https://planningvoter.kinghost.net
          API_PORT: 80
        run: |
          # Server environment file
          cp server/.env.production.example server/.env.production
          # Substituir valores usando envsubst
          export DB_HOST="${{ secrets.DB_HOST }}"
          export DB_USER="${{ secrets.DB_USER }}"
          export DB_PASSWORD="${{ secrets.DB_PASSWORD }}"
          export DB_NAME="${{ secrets.DB_NAME }}"
          export CLIENT_URL="$BASE_URL"
          export API_PORT="$API_PORT"
          export NODE_ENV="production"
          export COOKIE_DOMAIN="planningvoter.kinghost.net"
          export HEALTH_CHECK_KEY="${{ secrets.HEALTH_CHECK_KEY }}"
          envsubst < server/.env.production.example > server/.env.production

          # Client environment file
          cp client/.env.production.example client/.env.production
          # Substituir valores usando envsubst
          export REACT_APP_API_URL="$BASE_URL/api"
          export REACT_APP_SOCKET_URL="$BASE_URL"
          export REACT_APP_URL_LOCAL="$BASE_URL"
          export NODE_ENV="production"
          envsubst < client/.env.production.example > client/.env.production

      - name: Setup SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.VPS_PRIVATE_KEY }}" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key
          eval $(ssh-agent -s)
          ssh-add ~/.ssh/deploy_key
          
          # Test SSH connection
          ssh -o StrictHostKeyChecking=no -i ~/.ssh/deploy_key ${{ secrets.VPS_USERNAME }}@${{ secrets.VPS_HOST }} echo "SSH connection successful"

      - name: Copy files to VPS
        uses: appleboy/scp-action@master
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USERNAME }}
          key: ${{ secrets.VPS_PRIVATE_KEY }}
          source: "., !node_modules, !*/node_modules"
          target: "/planning-voter"
          strip_components: 0
          debug: true

      - name: Deploy to VPS
        uses: appleboy/ssh-action@v0.1.4
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USERNAME }}
          key: ${{ secrets.VPS_PRIVATE_KEY }}
          debug: true
          script: |
            # Navega para o diretório do projeto
            cd /planning-voter

            # Verifica os arquivos .env.production
            if [ ! -f server/.env.production ]; then
              echo "Arquivo server/.env.production não encontrado"
              exit 1
            fi
            
            if [ ! -f client/.env.production ]; then
              echo "Arquivo client/.env.production não encontrado"
              exit 1
            fi

            # Para os containers atuais
            docker-compose -f docker-compose.prod.yml down

            # Limpa recursos não utilizados
            docker system prune -af --volumes

            # Constrói e inicia os novos containers com logs
            docker-compose -f docker-compose.prod.yml up -d --build

            # Espera 30 segundos para os containers iniciarem
            echo "Aguardando containers iniciarem..."
            sleep 30

            # Verifica logs dos containers
            docker-compose -f docker-compose.prod.yml logs

            # Lista todos os containers
            docker ps -a

      - name: Verify Deployment
        uses: appleboy/ssh-action@v0.1.4
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USERNAME }}
          key: ${{ secrets.VPS_PRIVATE_KEY }}
          script: |
            cd /planning-voter

            # Verifica status dos containers
            echo "Verificando status dos containers..."
            docker-compose -f docker-compose.prod.yml ps

            # Verifica logs dos containers
            echo "Verificando logs dos containers..."
            docker-compose -f docker-compose.prod.yml logs --tail=50

            # Verifica se os containers estão rodando
            if ! docker-compose -f docker-compose.prod.yml ps | grep -q "Up"; then
              echo "Deployment failed - containers are not running"
              docker-compose -f docker-compose.prod.yml logs
              exit 1
            fi

            # Espera o servidor estar pronto
            echo "Verificando se o servidor está respondendo..."
            for i in {1..6}; do
              if curl -f -H "X-Health-Check-Key: ${HEALTH_CHECK_KEY}" http://localhost:4000/api/health; then
                echo "Servidor está respondendo!"
                exit 0
              fi
              echo "Tentativa $i - Servidor ainda não está respondendo..."
              sleep 10
            done

            echo "Servidor não respondeu após 60 segundos"
            exit 1
